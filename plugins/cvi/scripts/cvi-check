#!/bin/bash

# CVI - Claude Voice Integration
# Setup diagnostic tool

CONFIG_DIR="$HOME/.cvi"
CONFIG_FILE="$CONFIG_DIR/config"

# Determine scripts directory (plugin or standalone)
if [ -n "$CLAUDE_PLUGIN_ROOT" ]; then
    SCRIPTS_DIR="$CLAUDE_PLUGIN_ROOT/scripts"
    PLUGIN_MODE=true
else
    # Try to find plugin cache location
    PLUGIN_CACHE="$HOME/.claude/plugins/cache/claude-tools/cvi"
    if [ -d "$PLUGIN_CACHE" ]; then
        # Find latest version
        LATEST_VERSION=$(ls -1 "$PLUGIN_CACHE" 2>/dev/null | sort -V | tail -1)
        if [ -n "$LATEST_VERSION" ]; then
            SCRIPTS_DIR="$PLUGIN_CACHE/$LATEST_VERSION/scripts"
            PLUGIN_MODE=true
        else
            SCRIPTS_DIR="$HOME/.claude/scripts"
            PLUGIN_MODE=false
        fi
    else
        SCRIPTS_DIR="$HOME/.claude/scripts"
        PLUGIN_MODE=false
    fi
fi

echo "🔍 CVI セットアップ診断"
echo ""

# Check Siri voice
echo -n "Siri音声: "
if command -v say >/dev/null 2>&1; then
    TEST_AUDIO="/tmp/cvi_voice_test_$$.aiff"
    say -o "$TEST_AUDIO" "test" 2>/dev/null

    if [ -f "$TEST_AUDIO" ]; then
        FILE_SIZE=$(stat -f%z "$TEST_AUDIO" 2>/dev/null || echo "0")
        rm -f "$TEST_AUDIO"

        if [ "$FILE_SIZE" -gt 10000 ]; then
            echo "✅ 設定済み（推定）"
            SIRI_OK=true
        else
            echo "⚠️  未設定の可能性があります"
            SIRI_OK=false
        fi
    else
        echo "❌ 音声生成に失敗"
        SIRI_OK=false
    fi
else
    echo "❌ sayコマンドが見つかりません"
    SIRI_OK=false
fi

# Check script permissions
echo -n "スクリプト実行権限: "
SCRIPTS_OK=true
MISSING_SCRIPTS=""
for script in notify-end.sh kill-voice.sh; do
    if [ ! -x "$SCRIPTS_DIR/$script" ]; then
        MISSING_SCRIPTS="$MISSING_SCRIPTS $script"
        SCRIPTS_OK=false
    fi
done
if $SCRIPTS_OK; then
    echo "✅ OK"
else
    echo "❌ 以下のスクリプトに実行権限がありません:$MISSING_SCRIPTS"
fi

# Check hooks configuration
echo -n "hooks設定: "
if $PLUGIN_MODE; then
    # Plugin mode: check plugin's hooks.json
    HOOKS_JSON="$SCRIPTS_DIR/../hooks/hooks.json"
    if [ -f "$HOOKS_JSON" ]; then
        if grep -q "notify-end.sh" "$HOOKS_JSON" && grep -q "kill-voice.sh" "$HOOKS_JSON"; then
            echo "✅ OK (プラグインモード)"
            HOOKS_OK=true
        else
            echo "⚠️  hooks.json が不完全"
            HOOKS_OK=false
        fi
    else
        echo "❌ hooks.json が見つかりません"
        HOOKS_OK=false
    fi
else
    # Standalone mode: check settings.json
    SETTINGS_FILE="$HOME/.claude/settings.json"
    if [ -f "$SETTINGS_FILE" ]; then
        if grep -q "notify-end.sh" "$SETTINGS_FILE" && grep -q "kill-voice.sh" "$SETTINGS_FILE"; then
            echo "✅ OK"
            HOOKS_OK=true
        else
            echo "⚠️  不完全"
            HOOKS_OK=false
        fi
    else
        echo "❌ settings.jsonが見つかりません"
        HOOKS_OK=false
    fi
fi

# Check configuration file
if [ -f "$CONFIG_FILE" ]; then
    # Read speech rate
    SPEECH_RATE=$(grep "^SPEECH_RATE=" "$CONFIG_FILE" | cut -d'=' -f2)
    SPEECH_RATE=${SPEECH_RATE:-200}
    echo "✅ 読み上げ速度: ${SPEECH_RATE} wpm"

    # Read language
    VOICE_LANG=$(grep "^VOICE_LANG=" "$CONFIG_FILE" | cut -d'=' -f2)
    VOICE_LANG=${VOICE_LANG:-ja}
    case "$VOICE_LANG" in
        ja)
            echo "✅ 言語設定: 日本語"
            ;;
        en)
            echo "✅ 言語設定: English"
            # Show English voice setting
            VOICE_EN=$(grep "^VOICE_EN=" "$CONFIG_FILE" | cut -d'=' -f2)
            VOICE_EN=${VOICE_EN:-Samantha}
            echo "✅ 英語音声: $VOICE_EN"
            ;;
        *)
            echo "⚠️  言語設定: $VOICE_LANG (不明)"
            ;;
    esac
else
    echo "ℹ️  設定ファイル: デフォルト設定を使用中"
fi

# Show mode info
echo ""
if $PLUGIN_MODE; then
    echo "ℹ️  インストールモード: プラグイン"
    echo "   スクリプトパス: $SCRIPTS_DIR"
else
    echo "ℹ️  インストールモード: スタンドアロン"
fi

echo ""

# Summary
if $SIRI_OK && $SCRIPTS_OK && $HOOKS_OK; then
    echo "✅ すべて正常です！"
    exit 0
else
    echo "⚠️  問題が見つかりました"
    echo ""

    if ! $SIRI_OK; then
        cat <<EOF
【Siri音声の設定方法】
より自然で流暢な読み上げのために、Siri音声の設定をおすすめします：

1. システム設定 > アクセシビリティ > 読み上げコンテンツ
2. 「システムの声」で「Siri (声2)」または「Eloquence」を選択
3. 設定完了後、以下のコマンドでテスト：
   say "これはテストメッセージです"

Siri音声で読み上げられれば設定完了です。

EOF
    fi

    if ! $SCRIPTS_OK; then
        if $PLUGIN_MODE; then
            cat <<EOF
【スクリプト実行権限の付与】
chmod +x "$SCRIPTS_DIR"/*.sh

EOF
        else
            cat <<EOF
【スクリプト実行権限の付与】
chmod +x ~/.claude/scripts/*.sh
chmod +x ~/.claude/scripts/cvi-*

EOF
        fi
    fi

    if ! $HOOKS_OK; then
        if $PLUGIN_MODE; then
            cat <<EOF
【hooks設定】
プラグインのhooksが正しく読み込まれていない可能性があります。
Claude Codeを再起動してください。

EOF
        else
            cat <<EOF
【hooks設定】
~/.claude/settings.jsonにhooksを追加してください。
詳細は README.md を参照してください。

EOF
        fi
    fi

    exit 1
fi
